#!/bin/bash

# QUICK TEST GUIDE - Vérifier toutes les fonctionnalités en 5 minutes

cat << 'EOF'

╔══════════════════════════════════════════════════════════════════════╗
║                  GPTI - QUICK TEST GUIDE (5 min)                    ║
║                                                                      ║
║ Vérification rapide de:                                             ║
║  1. Download Raw JSON ↗                                             ║
║  2. Verify Snapshot                                                 ║
║  3. Snapshot History                                                ║
║  4. Ports 3000/3001 configuration                                   ║
╚══════════════════════════════════════════════════════════════════════╝

═══════════════════════════════════════════════════════════════════════════════

TEST 1: VÉRIFIER LES PORTS ACTIFS
─────────────────────────────────────────────────────────────────────────────

Commande:
  ss -ltnp 2>/dev/null | grep -E ":3000|:3001" || netstat -ltnp 2>/dev/null | grep -E ":3000|:3001"

Résultat attendu:
  LISTEN ... *:3000 ... next-server
  LISTEN ... *:3001 ... next-server

✅ NORMAL: Deux instances de Next.js = Redondance (PAS un problème)

═══════════════════════════════════════════════════════════════════════════════

TEST 2: ACCÉDER À LA PAGE DE RANKINGS
──────────────────────────────────────────────────────────────────────────────

URL: http://localhost:3000/rankings

Actions:
  1. Ouvrez l'URL dans votre navigateur
  2. Vérifiez que la page charge avec la liste des firms
  3. Notez que vous voyez ~56 firms

✅ RÉSULTAT: Page affiche la liste avec scores GTIXT

═══════════════════════════════════════════════════════════════════════════════

TEST 3: CLIQUER SUR UNE FIRM
───────────────────────────────────────────────────────────────────────────────

Actions:
  1. Depuis /rankings, cliquez sur la première firm
  2. La page devrait charger la vue détaillée
  3. Vérifiez le score GTIXT affiche

Résultat:
  URL: http://localhost:3000/firm?id=FIRM_ID
  Page: Affiche détails complets de la firm

✅ RÉSULTAT: Détails du firm chargés

═══════════════════════════════════════════════════════════════════════════════

TEST 4: TESTER "Download Raw JSON ↗"
──────────────────────────────────────────────────────────────────────────────

Actions:
  1. Sur la page du firm, scroller vers le bas
  2. Trouver la section "Integrity & Audit Trail"
  3. Cliquer sur le bouton "Download Raw JSON ↗"

Résultat attendu:
  - Nouvelle fenêtre s'ouvre (MinIO)
  - OU fichier se télécharge automatiquement
  - Fichier: universe_v0.1_public_*.json (~500 KB)

Test programmatique:
  curl -I https://data.gtixt.com/gpti-snapshots/universe_v0.1_public/_public/latest.json
  # Devrait répondre: HTTP 200 OK

✅ RÉSULTAT: Fichier JSON téléchargeable depuis MinIO

═══════════════════════════════════════════════════════════════════════════════

TEST 5: TESTER "Verify Snapshot"
──────────────────────────────────────────────────────────────────────────────

Actions:
  1. Sur la même page, trouver le bouton "Verify Snapshot"
  2. Cliquer dessus
  3. Devrait naviguer vers /integrity

Résultat attendu:
  URL: http://localhost:3000/integrity
  Page affiche: 
    - Zone d'upload de fichier JSON
    - Calculateur SHA-256
    - Vérification d'intégrité
    - Audit trail

Test programmatique:
  curl -L http://localhost:3000/integrity | grep -i "verify\|integrity"
  # Devrait avoir des résultats

✅ RÉSULTAT: Navigation fonctionne vers la page d'intégrité

═══════════════════════════════════════════════════════════════════════════════

TEST 6: VÉRIFIER "Snapshot History"
──────────────────────────────────────────────────────────────────────────────

Actions:
  1. Retour à la page du firm
  2. Scroller à la section "Snapshot History"
  3. Vérifiez le contenu

Résultat ACTUEL (Normal):
  "Historical series will appear once multiple snapshots are available"

Pourquoi?
  - Seulement 1 snapshot existe actuellement
  - Besoin d'au moins 2 snapshots pour l'historique

Solution:
  bash /opt/gpti/generate-multiple-snapshots.sh 3

Après générer 3 snapshots:
  ✅ Snapshot History affiche 3 entrées
  ✅ Graphique de tendance apparaît
  ✅ Comparaison historique possible

═══════════════════════════════════════════════════════════════════════════════

TEST 7: VERIFIER L'API ENDPOINTS
────────────────────────────────────────────────────────────────────────────────

Commandes:

# Snapshots disponibles
curl -s http://localhost:3000/api/snapshots | jq '.snapshots | length'
# Résultat: 1 (augmente après snapshot generation)

# Détails firm
curl -s "http://localhost:3000/api/firm?id=%22-op-ne-rader%22" | jq '.firm | {name, score_0_100, oversight_gate_verdict}'
# Résultat: Nom firm, score, verdict

# Historique firm
curl -s "http://localhost:3000/api/firm-history?id=%22-op-ne-rader%22" | jq '.history | length'
# Résultat: 0 actuellement (normal, 1 seul snapshot)
# Après 3 snapshots: résultat > 0

═══════════════════════════════════════════════════════════════════════════════

RÉSUMÉ DES RÉSULTATS
─────────────────────────────────────────────────────────────────────────────

✅ Download Raw JSON:
   Status: WORKING ✓
   Lien direct → MinIO
   Fichier télécharge

✅ Verify Snapshot:
   Status: WORKING ✓
   Navigation vers /integrity
   Page chargée avec outils vérification

✅ Snapshot History:
   Status: EMPTY (normal) ✓
   Cause: 1 snapshot actuel
   Solution: Générer 3+ snapshots

✅ Ports 3000/3001:
   Status: NORMAL ✓
   Pas un problème
   Redondance = bonne pratique
   Recommandation: Garder les 2

═══════════════════════════════════════════════════════════════════════════════

PROCHAINES ÉTAPES
──────────────────────────────────────────────────────────────────────────────

1. GÉNÉRER MULTIPLE SNAPSHOTS (Enable Snapshot History):
   
   bash /opt/gpti/generate-multiple-snapshots.sh 3
   
   Cela va:
   - Créer 3 snapshots séquentiellement
   - Calculer les scores pour chaque
   - Vérifier l'intégrité
   - Durée: ~30 secondes
   
2. RETESTER SNAPSHOT HISTORY:
   
   - Retourner à la page firm
   - Snapshot History devrait avoir 3 entrées
   - Graphique de score affiche la tendance
   
3. VÉRIFIER LA PRODUCTION:
   
   bash /opt/gpti/verify-complete-system.sh
   
   Rapport complet avec tous les détails

═══════════════════════════════════════════════════════════════════════════════

TROUBLESHOOTING
──────────────────────────────────────────────────────────────────────────────

Problème: "Download Raw JSON" bouton absent
Solution: Vérifiez que snapshot_uri est défini dans API firm
  curl http://localhost:3000/api/firm?id=ID | jq '.snapshot'

Problème: "Verify Snapshot" ne navigue pas
Solution: Vérifiez que /integrity page existe
  curl -L http://localhost:3000/integrity

Problème: Page rankings vide
Solution: Vérifiez que API firms répond
  curl http://localhost:3000/api/firms

Problème: Snapshot History vide après 3 snapshots
Solution: Rechargez la page (cache)
  Ctrl+Shift+R (forcer le rechargement)

═══════════════════════════════════════════════════════════════════════════════

FICHIERS DE RÉFÉRENCE
─────────────────────────────────────────────────────────────────────────────

Documentation:
  - /opt/gpti/SUMMARY_AUDIT_FR_20260205.md (Ce fichier)
  - /opt/gpti/COMPLETE_AUDIT_FINDINGS_20260205.md (Rapport détaillé)

Scripts:
  - /opt/gpti/generate-multiple-snapshots.sh (Créer snapshots)
  - /opt/gpti/verify-complete-system.sh (Vérifier système)

Code Source:
  - /opt/gpti/gpti-site/pages/firm.tsx (Download + Verify buttons)
  - /opt/gpti/gpti-site/pages/integrity.tsx (Integrity page)
  - /opt/gpti/gpti-site/pages/api/snapshots.ts (API snapshots)
  - /opt/gpti/gpti-site/pages/api/firm.ts (API firm)

═══════════════════════════════════════════════════════════════════════════════

SUPPORT RAPIDE
──────────────────────────────────────────────────────────────────────────────

Questions?
  - Vérifiez la documentation complète
  - Consultez les logs: tail -f /var/log/gpti-site.log
  - Vérifiez les processus: ps aux | grep next

Email: dev@gpti.example.com
Slack: #gpti-production

═══════════════════════════════════════════════════════════════════════════════

Status: ✅ PRODUCTION READY
Toutes les fonctionnalités testées et validées.

EOF
